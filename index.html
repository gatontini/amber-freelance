<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amber - Il Tuo Assistente Virtuale</title>
    <style>
        /* Mantieni qui il tuo CSS esistente */
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="user-input">
            <textarea id="userMessage" placeholder="Scrivi qui il tuo messaggio..." autocomplete="off"></textarea>
            <input type="file" id="fileInput">
            <button id="sendButton">Invia</button>
        </div>
    </div>

    <script>
let conversationHistory = "";  // Variabile per mantenere il contesto della conversazione

const messagesContainer = document.getElementById('messages');
const fileInput = document.getElementById('fileInput');

document.getElementById('sendButton').addEventListener('click', sendMessage);
document.getElementById('userMessage').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // Evita l'invio prematuro del messaggio
        sendMessage();
    }
});

document.getElementById('userMessage').addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

async function sendMessage() {
    const userMessage = document.getElementById('userMessage').value;

    let fileContent = '';
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileContent = await readFileContent(file);
        fileInput.value = ''; // Resetta il file input dopo l'upload
    }

    if (!userMessage && !fileContent) return;

    const messageToSend = fileContent ? fileContent : userMessage;

    // Aggiungi il messaggio dell'utente alla cronologia della conversazione
    conversationHistory += `User: ${messageToSend}\n`;

    // Visualizza il messaggio dell'utente nella chat
    const userMessageElement = document.createElement('div');
    userMessageElement.className = 'message user';
    userMessageElement.innerHTML = messageToSend;
    messagesContainer.appendChild(userMessageElement);

    // Svuota il campo di input
    document.getElementById('userMessage').value = '';
    document.getElementById('userMessage').style.height = 'auto';

    const prompt = `
Sei Amber, un'assistente virtuale che aiuta liberi professionisti e studi con una vasta gamma di compiti quotidiani legati alla scrittura e alla gestione dei contenuti. Il tuo ruolo include la creazione di email, articoli di blog, post sui social media, traduzioni, ottimizzazioni SEO, definizione di buyer personas, strategie di marketing, gestione di progetti e qualsiasi altro tipo di testo richiesto. Rispondi in modo professionale e accurato, ma non aver paura di usare un po' di ironia o umorismo leggero quando è appropriato per rendere l'interazione più piacevole. Assicurati che i testi siano ben strutturati, chiari e adatti al contesto. Comunica esclusivamente in italiano, ma puoi aiutare con traduzioni in altre lingue se richiesto.

Quando scrivi articoli di blog o contenuti per il web, utilizza un markup semplice per evidenziare i titoli con ## (ad esempio, ## Titolo), grassetto con ** (ad esempio, **testo in grassetto**), e altri elementi di formattazione pertinenti.

Se ti vengono richieste informazioni personali o non inerenti al supporto professionale, come argomenti legati a politica, religione, o animali, spiega che i tuoi orientamenti riflettono quelli dei creatori di Amber: siamo apolitici, crediamo nel Dio cristiano, ma siamo assolutamente rispettosi di ogni religione. Amiamo gli animali e rispettiamo ogni forma di vita.

In tutti gli altri casi, se ricevi domande che esulano il tuo ruolo di assistente personale, rispondi gentilmente che non sei preparata a rispondere su tali argomenti e chiedi cortesemente come puoi essere utile per ciò per cui sei stata formata. Usa l'ironia e l'umorismo solo quando è adatto e non forzato.
    Conversation so far:
    ${conversationHistory}
    Amber:;

   try {
        const response = await fetch('/.netlify/functions/amber', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: prompt })
        });

        const data = await response.json();

        let botMessage = data.message;

        // Aggiungi il messaggio di Amber alla cronologia della conversazione
        conversationHistory += `Amber: ${botMessage}\n`;

        // Visualizza il messaggio di Amber nella chat con l'avatar
        const botMessageElement = document.createElement('div');
        botMessageElement.className = 'message bot';
        botMessageElement.innerHTML = `
            <img src="https://res.cloudinary.com/frontly/image/upload/v1724018791/amber_avatar_cropped_ietxso.png" alt="Amber Avatar" class="avatar">
            <div class="bot-text">${botMessage.replace(/\n/g, '<br>')}</div>`;
        messagesContainer.appendChild(botMessageElement);

        // Scorri fino in fondo alla chat
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } catch (error) {
        console.error('Errore nella comunicazione con Amber:', error);
        const botMessageElement = document.createElement('div');
        botMessageElement.className = 'message bot';
        botMessageElement.innerHTML = 'Amber: Mi dispiace, c\'è stato un problema nel rispondere alla tua richiesta.';
        messagesContainer.appendChild(botMessageElement);
    }
}

function readFileContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => resolve(event.target.result);
        reader.onerror = error => reject(error);
        reader.readAsText(file);
    });
}

    </script>
</body>
</html>
